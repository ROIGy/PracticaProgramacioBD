<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../estils.css">
    <title>Disseny de la BD</title>
</head>

<body>
    <nav id="barra_menu">
        <a href="../index.html" class="index-link">Torna a l'Inici</a>
        <ul class="links">
            <li><a href="../punts_index/disseny_bd.html">Disseny de la BD</a></li>
            <li><a href="../punts_index/uml.html">UML - Diagrama de classes</a></li>
            <li><a href="../punts_index/manual_d'us.html">Manual d'ús de l'aplicació</a></li>
            <li><a href="../punts_index/resolucio_errors.html">Resolució de problemes i errors</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>Resolució de problemes i errors</h1>
        <p>Aquí veurem alguns problemes i errors que he tingut durant el procés de programació del codi font i a l'enllaçament amb
            altres eines i aplicacions.
        </p>
        
        <h2>La connexió es queda tancada i no es poden fer consultes</h2>

        <p>Al principi de l'elaboració del projecte vaig començar creant una nova variable connexió per a cada mètode del controlador.
            Després vaig descobrir que era molt més pràctic tenir una sola variable connexió com a atribut de cadascuna de les classes
            de controlador que requerissin consultes cridant mètodes del model, però després em vaig adonar que això podia comportar alguns
            errors inesperats. <br> 
            En alguns mètodes d'alguna de les classes controlador (principalment a la classe ReservesController) he trobat l'error que la connexió estava tancada, i encara
            que la obrís, algun mètode la tancava a mig mètode i no permetia fer les consultes necessàries criant els mètodes del model. <br>
            Això ho vaig solucionar utilitzant variables connexió específiques per als mètodes amb consultes que donessin error utilitzant la variable atribut.

        </p>

        <pre class="java-code">

            <span class="keyword">try</span> (<span class="class">Connection</span> connection1 = <span class="keyword">new</span> <span class="class">Connexio</span>().<span class="method">connecta</span>()) {
                <span class="keyword">boolean</span> coincidencia = model.<span class="method">checkHabitacioLliure</span>(connection1, dataChkIn, dataChkOut, escullHab.<span class="method">getSelectionModel</span>().<span class="method">getSelectedItem</span>().<span class="method">getIdHabitacio</span>());
                <span class="keyword">if</span> (coincidencia == <span class="keyword">true</span>) {
                    <span class="method">alerta</span>(<span class="string">"No es pot fer una reserva. L'habitació que has seleccionat està ocupada en aquestes dates."</span>);
                    campsOmplerts = <span class="keyword">false</span>;
                }
            } <span class="keyword">catch</span> (<span class="class">SQLException</span> e) {
                <span class="method">alerta</span>(<span class="string">"Error en establir connexió amb la base de dades: "</span> + e.<span class="method">getMessage</span>());
            }
        </pre>
        <br>

        <h2>Lògica incorrecta del mètode "Desa els canvis" a l'apartat de tasques.</h2>
        <p>A l'apartat de tasques vaig arrossegar un problema del que no trobava solució durant molt temps.
            Un cop introdueixes un NIF d'empleat que tingui tasques pendents, s'habiliten tots els camps que et mostren les 
            característiques de la tasca. Al final d'aquesta part de la pàgina hi ha un botó "Desa els canvis", pensat per fer 
            la consulta de canviar totes les columnes a la taula Tasca de la fila de la tasca que s'hagués seleccionat al desplegable.
        </p>
        <div class="image-container">
            <img src="/punts_index/imgs_errors/tasques_desarcanvis_cap.png" alt="Camps d'una tasca creada">
            <img src="/punts_index/imgs_errors/tasques_desarcanvis_cap2.png" alt="Camps d'una tasca creada 2">
        </div>
        <p>El problema va ser que la consulta que actualitzava els canvis a la taula Tasca actualitzava directament tots els camps de la seguent manera:
        </p>
        <pre class="java-code">
            <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="method">editarTasca</span>(<span class="class">Connection</span> connection, <span class="keyword">int</span> idTasca, <span class="class">String</span> novaDataExecucio) <span class="keyword">throws</span> <span class="class">SQLException</span> {
                <span class="class">String</span> sql = <span class="string">"UPDATE tasca SET data_execucio = ? WHERE IdTasca = ?"</span>;
                <span class="keyword">try</span> (<span class="class">PreparedStatement</span> ordre = connection.<span class="method">prepareStatement</span>(sql)) {
                    ordre.<span class="method">setString</span>(<span class="number">1</span>, novaDataExecucio);
                    ordre.<span class="method">setInt</span>(<span class="number">2</span>, idTasca);
            
                    <span class="keyword">int</span> rowsUpdated = ordre.<span class="method">executeUpdate</span>();
                    <span class="keyword">return</span> rowsUpdated > <span class="number">0</span>;
            
                } <span class="keyword">catch</span> (<span class="class">SQLException</span> e) {
                    <span class="class">System</span>.err.<span class="method">println</span>(<span class="string">"Error en actualitzar la tasca a la BD: "</span> + e.<span class="method">getMessage</span>());
                    <span class="keyword">return</span> <span class="keyword">false</span>;
                }
            }
            </pre>
</body>

</html>